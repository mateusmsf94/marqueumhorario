<div class="flex min-h-full flex-col py-12 sm:px-6 lg:px-8">
  <div class="mx-auto w-full sm:max-w-4xl">
    <div class="bg-white px-6 py-8 shadow-sm sm:rounded-lg dark:bg-gray-800/50">
      <div class="mb-8">
        <h2 class="text-2xl font-bold tracking-tight text-gray-900 dark:text-white">Working Plan</h2>
        <p class="mt-2 text-sm/6 text-gray-600 dark:text-gray-300">
          Mark below the days and hours that your company will accept appointments. You will be able to adjust appointments in non-working hours but the customers will not be able to book appointments by themselves in non-working periods. This working plan will be the default for every new provider record, but you will be able to change each provider's plan separately by editing his record. After that you can add break periods.
        </p>
      </div>

      <%= form_with(model: @office, url: update_working_plan_office_path(@office), method: :patch, local: true) do |form| %>
        <!-- Time Slot Duration Section -->
        <div class="mb-8 border-b border-gray-200 dark:border-gray-700 pb-8">
          <h3 class="text-lg font-semibold text-gray-900 dark:text-white mb-4">Time Slot Duration</h3>
          <p class="text-sm text-gray-600 dark:text-gray-300 mb-4">
            Select the duration for each appointment time slot. This will determine how the available times are divided throughout the day.
          </p>

          <div class="flex items-center gap-4">
            <label for="time_slot_duration" class="text-sm font-medium text-gray-900 dark:text-white">
              Duration (minutes):
            </label>
            <%= select_tag "office[working_plan][time_slot_duration]",
              options_for_select([
                ["15 minutes", 15],
                ["30 minutes", 30],
                ["45 minutes", 45],
                ["1 hour", 60],
                ["1.5 hours", 90],
                ["2 hours", 120]
              ], @office.working_plan["time_slot_duration"] || 30),
              class: "block w-48 rounded-md border-0 py-2 pl-3 pr-10 text-gray-900 ring-1 ring-inset ring-gray-300 focus:ring-2 focus:ring-indigo-600 dark:bg-gray-700 dark:text-white dark:ring-gray-600 dark:focus:ring-indigo-500 sm:text-sm/6" %>
          </div>

          <div id="slot-preview" class="mt-4 p-4 bg-gray-50 dark:bg-gray-900/50 rounded-md">
            <p class="text-xs font-medium text-gray-700 dark:text-gray-300 mb-2">Preview: Example time slots for a day</p>
            <div id="slot-examples" class="flex flex-wrap gap-2">
              <!-- JavaScript will populate this -->
            </div>
          </div>
        </div>

        <!-- Days and Hours Section -->
        <div class="mb-12">
          <div class="overflow-x-auto">
            <table class="min-w-full divide-y divide-gray-200 dark:divide-gray-700">
              <thead>
                <tr class="bg-gray-50 dark:bg-gray-900/50">
                  <th scope="col" class="py-3.5 pl-4 pr-3 text-left text-sm font-semibold text-gray-900 dark:text-white sm:pl-6">
                    DAY
                  </th>
                  <th scope="col" class="px-3 py-3.5 text-left text-sm font-semibold text-gray-900 dark:text-white">
                    START
                  </th>
                  <th scope="col" class="px-3 py-3.5 text-left text-sm font-semibold text-gray-900 dark:text-white">
                    END
                  </th>
                </tr>
              </thead>
              <tbody class="divide-y divide-gray-200 dark:divide-gray-700">
                <% %w[sunday monday tuesday wednesday thursday friday saturday].each do |day| %>
                  <% day_data = @office.working_plan.dig("days", day) || {} %>
                  <tr class="<%= cycle('bg-white dark:bg-gray-800/50', 'bg-gray-50 dark:bg-gray-900/50') %>">
                    <td class="whitespace-nowrap py-4 pl-4 pr-3 sm:pl-6">
                      <label class="flex items-center gap-x-3">
                        <%= check_box_tag "office[working_plan][days][#{day}][enabled]", "1", day_data["enabled"],
                          class: "h-4 w-4 rounded border-gray-300 text-indigo-600 focus:ring-indigo-600 dark:border-gray-600 dark:bg-gray-700" %>
                        <span class="text-sm font-medium text-gray-900 dark:text-white">
                          <%= day.capitalize %>
                        </span>
                      </label>
                    </td>
                    <td class="whitespace-nowrap px-3 py-4">
                      <%= time_field_tag "office[working_plan][days][#{day}][start]", day_data["start"],
                        class: "block w-32 rounded-md border-0 py-1.5 text-gray-900 shadow-sm ring-1 ring-inset ring-gray-300 placeholder:text-gray-400 focus:ring-2 focus:ring-inset focus:ring-indigo-600 dark:bg-gray-700 dark:text-white dark:ring-gray-600 dark:focus:ring-indigo-500 sm:text-sm/6" %>
                    </td>
                    <td class="whitespace-nowrap px-3 py-4">
                      <%= time_field_tag "office[working_plan][days][#{day}][end]", day_data["end"],
                        class: "block w-32 rounded-md border-0 py-1.5 text-gray-900 shadow-sm ring-1 ring-inset ring-gray-300 placeholder:text-gray-400 focus:ring-2 focus:ring-inset focus:ring-indigo-600 dark:bg-gray-700 dark:text-white dark:ring-gray-600 dark:focus:ring-indigo-500 sm:text-sm/6" %>
                    </td>
                  </tr>
                <% end %>
              </tbody>
            </table>
          </div>

          <div class="mt-6 flex justify-end">
            <button type="button" id="apply-to-all" class="inline-flex items-center gap-x-1.5 rounded-md bg-white px-3 py-2 text-sm font-semibold text-gray-900 shadow-sm ring-1 ring-inset ring-gray-300 hover:bg-gray-50 dark:bg-gray-700 dark:text-white dark:ring-gray-600 dark:hover:bg-gray-600">
              <svg class="h-5 w-5 text-gray-500 dark:text-gray-400" viewBox="0 0 20 20" fill="currentColor">
                <path fill-rule="evenodd" d="M16.704 4.153a.75.75 0 01.143 1.052l-8 10.5a.75.75 0 01-1.127.075l-4.5-4.5a.75.75 0 011.06-1.06l3.894 3.893 7.48-9.817a.75.75 0 011.05-.143z" clip-rule="evenodd" />
              </svg>
              APPLY TO ALL PROVIDERS
            </button>
          </div>
        </div>

        <!-- Breaks Section -->
        <div class="border-t border-gray-200 dark:border-gray-700 pt-8">
          <div class="mb-6">
            <h3 class="text-lg font-semibold text-gray-900 dark:text-white">Breaks</h3>
            <p class="mt-1 text-sm text-gray-600 dark:text-gray-300">
              Add the working breaks during each day. These breaks will be applied for all new providers.
            </p>
          </div>

          <button type="button" id="add-break" class="inline-flex items-center gap-x-2 rounded-md bg-indigo-600 px-3.5 py-2 text-sm font-semibold text-white shadow-sm hover:bg-indigo-500 focus-visible:outline focus-visible:outline-2 focus-visible:outline-offset-2 focus-visible:outline-indigo-600 dark:bg-indigo-500 dark:hover:bg-indigo-400">
            <svg class="-ml-0.5 h-5 w-5" viewBox="0 0 20 20" fill="currentColor">
              <path d="M10.75 4.75a.75.75 0 00-1.5 0v4.5h-4.5a.75.75 0 000 1.5h4.5v4.5a.75.75 0 001.5 0v-4.5h4.5a.75.75 0 000-1.5h-4.5v-4.5z" />
            </svg>
            ADD BREAK
          </button>

          <div id="breaks-container" class="mt-6">
            <div class="overflow-x-auto">
              <table class="min-w-full divide-y divide-gray-200 dark:divide-gray-700">
                <thead>
                  <tr class="bg-gray-50 dark:bg-gray-900/50">
                    <th scope="col" class="py-3.5 pl-4 pr-3 text-left text-sm font-semibold text-gray-900 dark:text-white sm:pl-6">
                      DAY
                    </th>
                    <th scope="col" class="px-3 py-3.5 text-left text-sm font-semibold text-gray-900 dark:text-white">
                      START
                    </th>
                    <th scope="col" class="px-3 py-3.5 text-left text-sm font-semibold text-gray-900 dark:text-white">
                      END
                    </th>
                    <th scope="col" class="relative py-3.5 pl-3 pr-4 sm:pr-6">
                      <span class="sr-only">Actions</span>
                    </th>
                  </tr>
                </thead>
                <tbody id="breaks-list" class="divide-y divide-gray-200 dark:divide-gray-700">
                  <% %w[sunday monday tuesday wednesday thursday friday saturday].each do |day| %>
                    <% breaks = @office.working_plan.dig("breaks", day) || [] %>
                    <% breaks.each_with_index do |break_data, index| %>
                      <tr class="break-row <%= cycle('bg-white dark:bg-gray-800/50', 'bg-gray-50 dark:bg-gray-900/50') %>" data-day="<%= day %>">
                        <td class="whitespace-nowrap py-4 pl-4 pr-3 text-sm font-medium text-gray-900 dark:text-white sm:pl-6">
                          <%= day.capitalize %>
                          <%= hidden_field_tag "office[working_plan][breaks][#{day}][][day]", day %>
                        </td>
                        <td class="whitespace-nowrap px-3 py-4">
                          <%= time_field_tag "office[working_plan][breaks][#{day}][][start]", break_data["start"],
                            class: "block w-32 rounded-md border-0 py-1.5 text-gray-900 shadow-sm ring-1 ring-inset ring-gray-300 placeholder:text-gray-400 focus:ring-2 focus:ring-inset focus:ring-indigo-600 dark:bg-gray-700 dark:text-white dark:ring-gray-600 dark:focus:ring-indigo-500 sm:text-sm/6" %>
                        </td>
                        <td class="whitespace-nowrap px-3 py-4">
                          <%= time_field_tag "office[working_plan][breaks][#{day}][][end]", break_data["end"],
                            class: "block w-32 rounded-md border-0 py-1.5 text-gray-900 shadow-sm ring-1 ring-inset ring-gray-300 placeholder:text-gray-400 focus:ring-2 focus:ring-inset focus:ring-indigo-600 dark:bg-gray-700 dark:text-white dark:ring-gray-600 dark:focus:ring-indigo-500 sm:text-sm/6" %>
                        </td>
                        <td class="relative whitespace-nowrap py-4 pl-3 pr-4 text-right text-sm font-medium sm:pr-6">
                          <button type="button" class="edit-break inline-flex items-center rounded-md bg-white px-2.5 py-1.5 text-sm font-semibold text-gray-900 shadow-sm ring-1 ring-inset ring-gray-300 hover:bg-gray-50 dark:bg-gray-700 dark:text-white dark:ring-gray-600 dark:hover:bg-gray-600 mr-2">
                            <svg class="h-4 w-4" viewBox="0 0 20 20" fill="currentColor">
                              <path d="M2.695 14.763l-1.262 3.154a.5.5 0 00.65.65l3.155-1.262a4 4 0 001.343-.885L17.5 5.5a2.121 2.121 0 00-3-3L3.58 13.42a4 4 0 00-.885 1.343z" />
                            </svg>
                          </button>
                          <button type="button" class="delete-break inline-flex items-center rounded-md bg-white px-2.5 py-1.5 text-sm font-semibold text-red-600 shadow-sm ring-1 ring-inset ring-gray-300 hover:bg-red-50 dark:bg-gray-700 dark:ring-gray-600 dark:hover:bg-red-900/20">
                            <svg class="h-4 w-4" viewBox="0 0 20 20" fill="currentColor">
                              <path fill-rule="evenodd" d="M8.75 1A2.75 2.75 0 006 3.75v.443c-.795.077-1.584.176-2.365.298a.75.75 0 10.23 1.482l.149-.022.841 10.518A2.75 2.75 0 007.596 19h4.807a2.75 2.75 0 002.742-2.53l.841-10.52.149.023a.75.75 0 00.23-1.482A41.03 41.03 0 0014 4.193V3.75A2.75 2.75 0 0011.25 1h-2.5zM10 4c.84 0 1.673.025 2.5.075V3.75c0-.69-.56-1.25-1.25-1.25h-2.5c-.69 0-1.25.56-1.25 1.25v.325C8.327 4.025 9.16 4 10 4zM8.58 7.72a.75.75 0 00-1.5.06l.3 7.5a.75.75 0 101.5-.06l-.3-7.5zm4.34.06a.75.75 0 10-1.5-.06l-.3 7.5a.75.75 0 101.5.06l.3-7.5z" clip-rule="evenodd" />
                            </svg>
                          </button>
                        </td>
                      </tr>
                    <% end %>
                  <% end %>
                </tbody>
              </table>
            </div>
          </div>
        </div>

        <!-- Form Actions -->
        <div class="mt-10 flex items-center justify-end gap-x-4 border-t border-gray-200 dark:border-gray-700 pt-6">
          <%= link_to "Cancel", offices_path, class: "text-sm/6 font-semibold text-gray-900 dark:text-white hover:text-gray-700 dark:hover:text-gray-300" %>
          <%= form.submit "Save Working Plan", class: "rounded-md bg-indigo-600 px-3 py-2 text-sm font-semibold text-white shadow-sm hover:bg-indigo-500 focus-visible:outline focus-visible:outline-2 focus-visible:outline-offset-2 focus-visible:outline-indigo-600 dark:bg-indigo-500 dark:hover:bg-indigo-400" %>
        </div>
      <% end %>
    </div>
  </div>
</div>

<script>
document.addEventListener('DOMContentLoaded', function() {
  // Time slot preview generation
  function generateTimeSlotPreview() {
    const duration = parseInt(document.querySelector('select[name="office[working_plan][time_slot_duration]"]').value);
    const startTime = '09:00';
    const endTime = '12:00'; // Just show a few hours as preview
    const slotExamples = document.getElementById('slot-examples');

    slotExamples.innerHTML = '';

    let [currentHour, currentMinute] = startTime.split(':').map(Number);
    const [endHour, endMinute] = endTime.split(':').map(Number);
    const endTotalMinutes = endHour * 60 + endMinute;

    while (true) {
      const currentTotalMinutes = currentHour * 60 + currentMinute;
      const nextTotalMinutes = currentTotalMinutes + duration;

      if (nextTotalMinutes > endTotalMinutes) break;

      const nextHour = Math.floor(nextTotalMinutes / 60);
      const nextMinute = nextTotalMinutes % 60;

      const startStr = `${String(currentHour).padStart(2, '0')}:${String(currentMinute).padStart(2, '0')}`;
      const endStr = `${String(nextHour).padStart(2, '0')}:${String(nextMinute).padStart(2, '0')}`;

      const slotBadge = document.createElement('span');
      slotBadge.className = 'inline-flex items-center rounded-md bg-indigo-50 px-2 py-1 text-xs font-medium text-indigo-700 ring-1 ring-inset ring-indigo-700/10 dark:bg-indigo-500/10 dark:text-indigo-400 dark:ring-indigo-500/20';
      slotBadge.textContent = `${startStr} - ${endStr}`;
      slotExamples.appendChild(slotBadge);

      currentHour = nextHour;
      currentMinute = nextMinute;
    }

    if (slotExamples.children.length === 0) {
      slotExamples.innerHTML = '<span class="text-xs text-gray-500 dark:text-gray-400">No slots available with this duration</span>';
    }
  }

  // Initial preview generation
  generateTimeSlotPreview();

  // Update preview when duration changes
  document.querySelector('select[name="office[working_plan][time_slot_duration]"]').addEventListener('change', generateTimeSlotPreview);

  // Apply to all providers button
  document.getElementById('apply-to-all').addEventListener('click', function() {
    alert('This feature will be implemented to apply this schedule to all providers.');
  });

  // Add break button
  document.getElementById('add-break').addEventListener('click', function() {
    const breaksList = document.getElementById('breaks-list');
    const days = ['sunday', 'monday', 'tuesday', 'wednesday', 'thursday', 'friday', 'saturday'];

    days.forEach((day, index) => {
      const rowClass = index % 2 === 0 ? 'bg-white dark:bg-gray-800/50' : 'bg-gray-50 dark:bg-gray-900/50';
      const newRow = document.createElement('tr');
      newRow.className = `break-row ${rowClass}`;
      newRow.setAttribute('data-day', day);
      newRow.innerHTML = `
        <td class="whitespace-nowrap py-4 pl-4 pr-3 text-sm font-medium text-gray-900 dark:text-white sm:pl-6">
          ${day.charAt(0).toUpperCase() + day.slice(1)}
          <input type="hidden" name="office[working_plan][breaks][${day}][][day]" value="${day}">
        </td>
        <td class="whitespace-nowrap px-3 py-4">
          <input type="time" name="office[working_plan][breaks][${day}][][start]" value="14:30" class="block w-32 rounded-md border-0 py-1.5 text-gray-900 shadow-sm ring-1 ring-inset ring-gray-300 placeholder:text-gray-400 focus:ring-2 focus:ring-inset focus:ring-indigo-600 dark:bg-gray-700 dark:text-white dark:ring-gray-600 dark:focus:ring-indigo-500 sm:text-sm/6">
        </td>
        <td class="whitespace-nowrap px-3 py-4">
          <input type="time" name="office[working_plan][breaks][${day}][][end]" value="15:00" class="block w-32 rounded-md border-0 py-1.5 text-gray-900 shadow-sm ring-1 ring-inset ring-gray-300 placeholder:text-gray-400 focus:ring-2 focus:ring-inset focus:ring-indigo-600 dark:bg-gray-700 dark:text-white dark:ring-gray-600 dark:focus:ring-indigo-500 sm:text-sm/6">
        </td>
        <td class="relative whitespace-nowrap py-4 pl-3 pr-4 text-right text-sm font-medium sm:pr-6">
          <button type="button" class="edit-break inline-flex items-center rounded-md bg-white px-2.5 py-1.5 text-sm font-semibold text-gray-900 shadow-sm ring-1 ring-inset ring-gray-300 hover:bg-gray-50 dark:bg-gray-700 dark:text-white dark:ring-gray-600 dark:hover:bg-gray-600 mr-2">
            <svg class="h-4 w-4" viewBox="0 0 20 20" fill="currentColor">
              <path d="M2.695 14.763l-1.262 3.154a.5.5 0 00.65.65l3.155-1.262a4 4 0 001.343-.885L17.5 5.5a2.121 2.121 0 00-3-3L3.58 13.42a4 4 0 00-.885 1.343z" />
            </svg>
          </button>
          <button type="button" class="delete-break inline-flex items-center rounded-md bg-white px-2.5 py-1.5 text-sm font-semibold text-red-600 shadow-sm ring-1 ring-inset ring-gray-300 hover:bg-red-50 dark:bg-gray-700 dark:ring-gray-600 dark:hover:bg-red-900/20">
            <svg class="h-4 w-4" viewBox="0 0 20 20" fill="currentColor">
              <path fill-rule="evenodd" d="M8.75 1A2.75 2.75 0 006 3.75v.443c-.795.077-1.584.176-2.365.298a.75.75 0 10.23 1.482l.149-.022.841 10.518A2.75 2.75 0 007.596 19h4.807a2.75 2.75 0 002.742-2.53l.841-10.52.149.023a.75.75 0 00.23-1.482A41.03 41.03 0 0014 4.193V3.75A2.75 2.75 0 0011.25 1h-2.5zM10 4c.84 0 1.673.025 2.5.075V3.75c0-.69-.56-1.25-1.25-1.25h-2.5c-.69 0-1.25.56-1.25 1.25v.325C8.327 4.025 9.16 4 10 4zM8.58 7.72a.75.75 0 00-1.5.06l.3 7.5a.75.75 0 101.5-.06l-.3-7.5zm4.34.06a.75.75 0 10-1.5-.06l-.3 7.5a.75.75 0 101.5.06l.3-7.5z" clip-rule="evenodd" />
            </svg>
          </button>
        </td>
      `;
      breaksList.appendChild(newRow);
    });
  });

  // Delete break buttons (using event delegation for dynamically added rows)
  document.getElementById('breaks-list').addEventListener('click', function(e) {
    if (e.target.closest('.delete-break')) {
      const row = e.target.closest('tr');
      if (confirm('Are you sure you want to delete this break?')) {
        row.remove();
      }
    }
  });
});
</script>
