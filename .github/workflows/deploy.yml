name: Deploy

on:
  push:
    branches: [main]
  workflow_dispatch:

jobs:
  deploy:
    name: Deploy with Kamal
    runs-on: ubuntu-latest
    environment: staging
    concurrency:
      group: deploy-${{ github.ref }}
      cancel-in-progress: true
    permissions:
      contents: read

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Setup Ruby environment
        uses: ./.github/actions/setup-ruby

      - name: Get secrets from Bitwarden
        uses: bitwarden/sm-action@v2
        with:
          access_token: ${{ secrets.BW_ACCESS_TOKEN }}
          base_url: https://vault.bitwarden.com
          secrets: |
            363d9a24-a85b-4aff-ba7a-b37701865cee > KAMAL_REGISTRY_PASSWORD
            c814b8f0-6b3d-4788-ab96-b377017be8d3 > KAMAL_REGISTRY_USERNAME
            e2ee4d2a-efa8-4a71-8897-b37701806ab0 > MARQUEUMHORARIO_DATABASE_PASSWORD
            883b432b-f7f1-43ba-aa58-b377017c570e > POSTGRES_PASSWORD
            b7c375d9-2a63-4f00-ab0f-b3770176bb80 > RAILS_MASTER_KEY
            b459a4e8-7014-4f67-9f91-b3780161dcf6 > KAMAL_SSH_PRIVATE_KEY

      - name: Configure SSH for Kamal
        run: |
          install -m 700 -d ~/.ssh
          printf '%s\n' "$KAMAL_SSH_PRIVATE_KEY" > ~/.ssh/kamal
          chmod 600 ~/.ssh/kamal
          ssh-keyscan 54.242.197.228 >> ~/.ssh/known_hosts
          echo "KAMAL_SSH_KEY_PATH=$HOME/.ssh/kamal" >> "$GITHUB_ENV"

      - name: Set deploy version
        run: |
          echo "KAMAL_VERSION=${GITHUB_SHA}" >> "$GITHUB_ENV"

      - name: Deploy application
        env:
          RAILS_ENV: production
        run: |
          bundle exec kamal deploy --version "${KAMAL_VERSION}"
